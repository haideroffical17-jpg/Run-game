<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TwelveLab ‚Äì Pro Voice Generator (All-in-One)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--
    NOTE (Read this):
    ‚Ä¢ Downloadable MP3 requires a serverless endpoint at /api/tts (e.g., Netlify/Vercel).
    ‚Ä¢ If /api/tts is missing, this page auto-falls back to Browser TTS (play only).
    ‚Ä¢ To enable MP3 download, deploy a function at /api/tts that returns audio/mpeg.
  -->
  <style>
    :root{
      --p1:#667eea; --p2:#764ba2; --bg:#f7f7fb; --card:#fff; --text:#222; --muted:#6b7280;
      --ok:#155724; --okbg:#d4edda; --err:#721c24; --errbg:#f8d7da;
      --warn:#856404; --warnbg:#fff3cd; --border:#e5e7eb;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      min-height:100vh; background:linear-gradient(135deg,var(--p1),var(--p2));
      padding:24px; display:flex; align-items:center; justify-content:center;
    }
    .wrap{width:100%; max-width:820px}
    .card{
      background:var(--card); border-radius:20px; padding:28px; box-shadow:0 20px 60px rgba(0,0,0,.25)
    }
    h1{font-size:28px; text-align:center; color:var(--p1); margin-bottom:6px}
    .subtitle{color:#666; text-align:center; margin-bottom:20px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .row{display:grid; gap:8px; margin-bottom:14px}
    label{font-weight:600; color:#333}
    textarea,select,input{
      width:100%; padding:12px 14px; border:2px solid var(--border); border-radius:12px; font-size:16px; background:#fff
    }
    textarea{min-height:130px; resize:vertical}
    textarea:focus,select:focus,input:focus{outline:none; border-color:var(--p1)}
    .btn{
      appearance:none; border:0; border-radius:12px; padding:14px 16px; font-weight:700; font-size:16px; cursor:pointer;
      background:linear-gradient(135deg,var(--p1),var(--p2)); color:#fff; transition:transform .15s ease
    }
    .btn:hover:not(:disabled){transform:translateY(-2px)}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#e5e7eb; color:#111}
    .actions{display:flex; gap:10px; flex-wrap:wrap}
    .player{margin-top:16px; padding:16px; background:#f5f7fb; border-radius:12px; display:none}
    .player.active{display:block}
    audio{width:100%; margin-bottom:10px}
    .msg{display:none; margin-top:10px; padding:12px; border-radius:10px; font-weight:600}
    .msg.ok{display:block;background:var(--okbg); color:var(--ok)}
    .msg.err{display:block;background:var(--errbg); color:var(--err)}
    .msg.warn{display:block;background:var(--warnbg); color:var(--warn)}
    .badge{display:inline-flex; align-items:center; gap:8px; font-size:13px; color:#444; background:#f9fafb; border:1px dashed var(--border); padding:10px 12px; border-radius:10px; margin-bottom:14px}
    .spinner{width:42px;height:42px;border-radius:50%;border:4px solid #eef2ff;border-top-color:var(--p1);animation:spin 1s linear infinite; margin:14px auto; display:none}
    .spinner.active{display:block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .footer{text-align:center; color:#fff; margin-top:14px}
    .mode{display:flex; gap:10px; align-items:center; margin-bottom:10px}
    .mode small{color:var(--muted)}
    .hint{font-size:12px; color:#666}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üéôÔ∏è TwelveLab ‚Äì Professional Voice Generator</h1>
      <p class="subtitle">Text ‚Üí Speech with Play &amp; <strong>Download (MP3)</strong> ‚Äî auto-fallback if backend missing</p>

      <div class="badge" id="backendStatus">Checking backend‚Ä¶</div>

      <form class="row" onsubmit="handleGenerate(event)">
        <div class="row">
          <label for="text">üìù Your Text</label>
          <textarea id="text" required placeholder="Type here‚Ä¶">Hello! This is TwelveLab voice generator. It can convert your text into natural speech and provide an MP3 download when backend is configured.</textarea>
          <div class="hint">Tip: 1‚Äì2 short paragraphs work best.</div>
        </div>

        <div class="grid">
          <div class="row">
            <label for="voice">üé§ Voice</label>
            <select id="voice">
              <option>US English Female</option>
              <option>US English Male</option>
              <option>UK English Female</option>
              <option>UK English Male</option>
              <option>Hindi Female</option>
              <option>Arabic Female</option>
              <option>Chinese Female</option>
              <option>Spanish Female</option>
              <option>French Female</option>
              <option>German Female</option>
            </select>
          </div>
          <div class="row">
            <label>‚öôÔ∏è Rate &amp; Pitch (Browser mode)</label>
            <div class="grid">
              <input id="rate" type="range" min="0.5" max="2" step="0.1" value="1" />
              <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" />
            </div>
            <small class="hint">Rate: <span id="rateV">1.0</span> ‚Ä¢ Pitch: <span id="pitchV">1.0</span> (only for play-only mode)</small>
          </div>
        </div>

        <div class="actions">
          <button id="genBtn" class="btn" type="submit">üéµ Generate Voice</button>
          <button type="button" class="btn secondary" id="stopBtn" onclick="stopSpeaking()">‚èπ Stop</button>
          <button type="button" class="btn secondary" id="testBtn" onclick="testBackend()">üîÑ Re-check Backend</button>
        </div>
      </form>

      <div id="spin" class="spinner"></div>
      <div id="msg" class="msg"></div>

      <div id="player" class="player">
        <h3>üéß Generated Audio</h3>
        <audio id="audio" controls></audio>
        <div class="actions">
          <button class="btn" onclick="downloadAudio()">‚¨áÔ∏è Download MP3</button>
          <button class="btn secondary" onclick="copyBlobURL()">üîó Copy Audio URL</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <p><strong>Powered by Grow With Haider</strong> ‚Ä¢ 100% Frontend UI ‚Ä¢ MP3 via /api/tts</p>
    </div>
  </div>

  <script>
    // ====== STATE ======
    let BACKEND_OK = false;        // toggled after probe to /api/tts
    let currentUrl = null;         // blob URL from backend
    const backendBadge = document.getElementById('backendStatus');
    const msg = document.getElementById('msg');
    const spin = document.getElementById('spin');
    const audioEl = document.getElementById('audio');
    const player = document.getElementById('player');
    const genBtn = document.getElementById('genBtn');
    const rate = document.getElementById('rate');
    const pitch = document.getElementById('pitch');
    const rateV = document.getElementById('rateV');
    const pitchV = document.getElementById('pitchV');

    rate.addEventListener('input', ()=> rateV.textContent = Number(rate.value).toFixed(1));
    pitch.addEventListener('input', ()=> pitchV.textContent = Number(pitch.value).toFixed(1));

    // ====== BACKEND PROBE ======
    async function testBackend() {
      backendBadge.textContent = 'Checking backend‚Ä¶';
      backendBadge.style.borderColor = '#e5e7eb';
      try {
        // harmless OPTIONS/POST probe to see if function exists
        const r = await fetch('/api/tts', { method: 'OPTIONS' });
        BACKEND_OK = r.ok || r.status === 204;
      } catch { BACKEND_OK = false; }
      backendBadge.textContent = BACKEND_OK
        ? '‚úÖ Backend ready: MP3 download enabled'
        : '‚ö†Ô∏è Backend not found: Play-only mode (no MP3). Configure /api/tts for downloads.';
      backendBadge.style.borderColor = BACKEND_OK ? '#10b981' : '#f59e0b';
    }
    // run once on load
    testBackend();

    // ====== UI HELPERS ======
    function showOk(t){ msg.className='msg ok'; msg.textContent=t; msg.style.display='block'; }
    function showErr(t){ msg.className='msg err'; msg.textContent=t; msg.style.display='block'; }
    function showWarn(t){ msg.className='msg warn'; msg.textContent=t; msg.style.display='block'; }
    function startSpin(){ spin.classList.add('active'); genBtn.disabled = true; }
    function stopSpin(){ spin.classList.remove('active'); genBtn.disabled = false; }

    function stopSpeaking() {
      try { window.speechSynthesis.cancel(); } catch {}
    }

    // ====== BACKEND MODE (MP3) ======
    async function generateViaBackend(text, voice) {
      const res = await fetch('/api/tts', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ text, voice })
      });
      if (!res.ok) throw new Error('TTS failed: HTTP ' + res.status);
      const blob = await res.blob(); // audio/mpeg
      if (currentUrl) URL.revokeObjectURL(currentUrl);
      currentUrl = URL.createObjectURL(blob);
      return currentUrl;
    }

    // ====== PLAY-ONLY MODE (Browser TTS) ======
    function generateViaBrowser(text, voice) {
      // Browser SpeechSynthesis voices vary; we'll just speak (no real file).
      const u = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();
      // Try best match by name substring:
      const pick = voices.find(v => (v.name || '').toLowerCase().includes(voice.toLowerCase()))
                 || voices.find(v => (v.lang || '').toLowerCase().includes('en'))
                 || voices[0];
      if (pick) u.voice = pick;
      u.rate = parseFloat(rate.value);
      u.pitch = parseFloat(pitch.value);
      return new Promise((resolve, reject) => {
        u.onend = resolve;
        u.onerror = e => reject(new Error('Browser TTS error'));
        speechSynthesis.cancel(); // stop any existing
        speechSynthesis.speak(u);
      });
    }

    // ====== MAIN SUBMIT ======
    async function handleGenerate(e){
      e.preventDefault();
      const text = document.getElementById('text').value.trim();
      const voice = document.getElementById('voice').value;
      msg.style.display = 'none'; player.classList.remove('active');

      if (!text){ showErr('Please type some text.'); return; }

      startSpin();
      try {
        if (BACKEND_OK) {
          // MP3 from server
          const url = await generateViaBackend(text, voice);
          audioEl.src = url;
          player.classList.add('active');
          showOk('‚úÖ Voice generated! MP3 ready for download.');
        } else {
          // Play-only fallback
          await generateViaBrowser(text, voice);
          showWarn('Played via browser voices. To enable MP3 downloads, add /api/tts backend.');
        }
      } catch(err){
        showErr('‚ùå ' + (err?.message || 'Generation failed'));
      } finally {
        stopSpin();
      }
    }

    // ====== DOWNLOAD / CLIPBOARD ======
    function downloadAudio(){
      if (!BACKEND_OK){ showWarn('Backend missing ‚Äî cannot download.'); return; }
      if (!currentUrl){ showWarn('Generate audio first.'); return; }
      const a = document.createElement('a');
      a.href = currentUrl; a.download = `twelvelab-voice-${Date.now()}.mp3`;
      document.body.appendChild(a); a.click(); a.remove();
      showOk('‚úÖ Audio download started.');
    }
    function copyBlobURL(){
      if (!currentUrl){ showWarn('Generate audio first.'); return; }
      navigator.clipboard.writeText(currentUrl).then(
        ()=> showOk('üîó Temporary audio URL copied.'),
        ()=> showWarn('Could not copy URL.')
      );
    }

    // Expose for buttons
    window.handleGenerate = handleGenerate;
    window.stopSpeaking = stopSpeaking;
    window.downloadAudio = downloadAudio;
    window.copyBlobURL = copyBlobURL;
    window.testBackend = testBackend;

    // Voices can load async in some browsers
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => {};
    }
  </script>
</body>
</html>
