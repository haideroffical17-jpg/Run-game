<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGen Studio (One-Shot 2K)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { 
            font-family: 'Space Grotesk', sans-serif; 
            background-color: #000; 
            color: #fff; 
        }
        
        .studio-input {
            background: #0f0f0f;
            border: 1px solid #333;
            color: #fff;
            transition: all 0.2s;
        }
        .studio-input:focus {
            border-color: #00ff88;
            outline: none;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .studio-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
            color: #000;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        .studio-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }

        .image-card {
            background: #050505;
            border: 1px solid #1a1a1a;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .image-card:hover {
            border-color: #00ff88;
            transform: scale(1.01);
            z-index: 10;
        }

        /* Loading Animation */
        .scan-line {
            width: 100%;
            height: 2px;
            background: #00ff88;
            animation: scan 1.5s linear infinite;
        }
        @keyframes scan {
            0% { transform: translateY(-100px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(100px); opacity: 0; }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-[1920px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- Sidebar -->
        <div class="lg:col-span-3 space-y-6">
            <div class="pb-6 border-b border-gray-800">
                <h1 class="text-4xl font-bold tracking-tighter text-white">PRO<span class="text-[#00ff88]">GEN</span></h1>
                <p class="text-[10px] text-gray-500 mt-2 uppercase tracking-[0.3em] font-bold">One-Shot 2K Engine</p>
            </div>

            <div class="space-y-6">
                <div class="space-y-2">
                    <div class="flex justify-between items-end">
                        <label class="text-xs font-bold text-gray-500 uppercase">Input Prompts</label>
                        <span id="lineCount" class="text-[#00ff88] text-xs font-mono font-bold">0 Ready</span>
                    </div>
                    <textarea id="promptInput" rows="10" 
                        class="studio-input w-full rounded-none border-l-2 border-l-[#00ff88] p-4 text-sm font-mono leading-relaxed resize-none focus:bg-[#080808]"
                        placeholder="Paste prompts here...&#10;Engine is locked to Single Retry Mode."></textarea>
                </div>

                <div class="bg-[#0a0a0a] p-5 border border-gray-800 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-bold text-gray-200 block">Stable Stream</span>
                            <span class="text-[10px] text-gray-500">Optimized for First-Try Success</span>
                        </div>
                        <div class="h-2 w-2 rounded-full bg-[#00ff88] shadow-[0_0_10px_#00ff88] animate-pulse"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] text-gray-500 font-mono">
                        <div class="flex items-center gap-2"><span class="text-[#00ff88]">●</span> 2K Native</div>
                        <div class="flex items-center gap-2"><span class="text-[#00ff88]">●</span> No Grain</div>
                        <div class="flex items-center gap-2"><span class="text-[#00ff88]">●</span> Smart Seed</div>
                        <div class="flex items-center gap-2"><span class="text-[#00ff88]">●</span> Anti-Blur</div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-500 uppercase">Dimensions</label>
                    <select id="ratioSelect" class="studio-input w-full rounded-none p-3 text-sm font-mono">
                        <option value="landscape">2K Landscape (2560x1440)</option>
                        <option value="portrait">2K Portrait (1440x2560)</option>
                        <option value="square">2K Square (2048x2048)</option>
                    </select>
                </div>

                <button onclick="startBulkGeneration()" id="genBtn"
                    class="studio-btn w-full py-5 font-black text-sm tracking-widest flex items-center justify-center gap-3">
                    <span>GENERATE BATCH</span>
                    <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-black border-t-transparent rounded-full animate-spin"></div>
                </button>

                <!-- Status Panel -->
                <div id="progressArea" class="hidden space-y-1">
                    <div class="flex justify-between text-[10px] text-gray-500 font-mono">
                        <span id="statusText">INITIALIZING...</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="w-full bg-[#111] h-1">
                        <div id="progressBar" class="bg-[#00ff88] h-full w-0 shadow-[0_0_15px_#00ff88] transition-all duration-300"></div>
                    </div>
                </div>

                <button onclick="downloadAll()" id="downloadBtn" 
                    class="w-full py-4 bg-[#111] hover:bg-[#1a1a1a] text-gray-400 hover:text-white text-xs font-bold uppercase tracking-widest transition hidden border border-gray-800">
                    Download ZIP
                </button>
            </div>
        </div>

        <!-- Gallery -->
        <div class="lg:col-span-9 flex flex-col h-full">
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-900">
                <h2 class="text-xl font-light text-gray-400">HIGH-RES <span class="text-white font-bold">OUTPUT</span></h2>
                <button onclick="clearGallery()" class="text-[10px] text-gray-600 hover:text-[#00ff88] transition font-mono uppercase tracking-widest">Clear All</button>
            </div>
            
            <div id="imageGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                <div id="emptyState" class="col-span-full h-96 flex flex-col items-center justify-center border border-dashed border-gray-900 text-gray-800">
                    <p class="font-mono text-xs tracking-widest">AWAITING 2K INPUTS...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let generatedItems = [];
        let isProcessing = false;

        // --- 2K CLEAN ENGINE CONFIG ---
        const CLEAN_TAGS = "(masterpiece), (best quality), (2k resolution), (QHD), (sharp focus:1.4), (clean lines), (smooth texture), (noise free:1.5), (grain free:1.5), (clear photography), high fidelity";
        const NO_NOISE_PROMPT = "noise, film grain, grit, dots, blur, haze, distortion, low quality, jpeg artifacts, compression artifacts, dirty, messy";

        document.getElementById('promptInput').addEventListener('input', function(e) {
            const lines = e.target.value.split('\n').filter(line => line.trim() !== '').length;
            document.getElementById('lineCount').innerText = `${lines} Ready`;
        });

        async function startBulkGeneration() {
            if (isProcessing) return;
            const input = document.getElementById('promptInput').value;
            const prompts = input.split('\n').filter(line => line.trim() !== '');
            if (prompts.length === 0) return alert("Please input prompts");

            isProcessing = true;
            toggleUI(true);
            
            if(generatedItems.length > 0 && confirm("Clear previous results?")) {
                generatedItems = [];
                document.getElementById('imageGrid').innerHTML = '';
            } else if (generatedItems.length === 0) {
                document.getElementById('imageGrid').innerHTML = '';
            }

            const ratio = document.getElementById('ratioSelect').value;
            let width, height;
            
            switch(ratio) {
                case 'landscape': width = 2560; height = 1440; break;
                case 'portrait': width = 1440; height = 2560; break;
                case 'square': width = 2048; height = 2048; break;
            }

            for (let i = 0; i < prompts.length; i++) {
                const rawPrompt = prompts[i].trim();
                const cardId = `img-${Date.now()}-${i}`;
                
                createSlot(cardId, rawPrompt, i + 1);

                const finalPrompt = `${rawPrompt}, clean, smooth, ${CLEAN_TAGS} | negative_prompt: ${NO_NOISE_PROMPT}`;
                const encodedPrompt = encodeURIComponent(finalPrompt);
                const seed = Math.floor(Math.random() * 1000000000);
                
                const url = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=${width}&height=${height}&seed=${seed}&nologo=true&model=flux&enhance=false`;

                try {
                    // Stagger delay to ensure stability
                    await new Promise(r => setTimeout(r, 1000)); 
                    await fetchImageRecursive(url, cardId, rawPrompt, i);
                } catch (e) {
                    console.error(e);
                    markError(cardId);
                }
                
                updateProgress(i + 1, prompts.length);
            }

            isProcessing = false;
            toggleUI(false);
        }

        async function fetchImageRecursive(url, id, prompt, index, attempts = 0) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Server Reject");
                const blob = await response.blob();
                
                if(blob.size < 4000) throw new Error("File too small"); 

                const objectUrl = URL.createObjectURL(blob);
                generatedItems.push({ blob, name: `ProGen_2K_${index+1}.png` });
                renderSuccess(id, objectUrl, prompt, index);

            } catch (e) {
                // FIXED: Seed Rotation Logic
                if (attempts < 1) {
                    const delay = 3000;
                    console.warn(`Single Retry for #${index} after ${delay}ms`);
                    
                    await new Promise(r => setTimeout(r, delay)); 
                    
                    // Smart Fix: Replace seed on retry to avoid stuck server workers
                    let retryUrl = url;
                    if(retryUrl.includes("&seed=")) {
                        const newSeed = Math.floor(Math.random() * 1000000000);
                        retryUrl = retryUrl.replace(/&seed=\d+/, `&seed=${newSeed}`);
                    }
                    // Anti-cache param
                    retryUrl += `&retry=${Date.now()}`;

                    return fetchImageRecursive(retryUrl, id, prompt, index, attempts + 1);
                } else {
                    throw e;
                }
            }
        }

        function createSlot(id, prompt, idx) {
            const grid = document.getElementById('imageGrid');
            const div = document.createElement('div');
            div.id = id;
            div.className = "image-card relative aspect-video bg-[#050505] flex flex-col justify-between overflow-hidden rounded-lg";
            div.innerHTML = `
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-8 h-8 border-2 border-[#1a1a1a] border-t-[#00ff88] rounded-full animate-spin"></div>
                </div>
                <div class="z-10 p-3 bg-black/60 backdrop-blur-sm border-b border-white/5 flex justify-between items-center">
                    <span class="text-[10px] text-[#00ff88] font-bold font-mono">RENDERING...</span>
                    <span class="text-[10px] text-gray-500">#{idx}</span>
                </div>
            `;
            grid.prepend(div);
        }

        function renderSuccess(id, url, prompt, idx) {
            const div = document.getElementById(id);
            if (!div) return;
            div.innerHTML = `
                <img src="${url}" class="absolute inset-0 w-full h-full object-cover animate-[fadeIn_0.5s_ease-out]" loading="lazy">
                
                <div class="absolute inset-0 bg-black/80 opacity-0 hover:opacity-100 transition-opacity duration-200 flex flex-col justify-center items-center gap-3 backdrop-blur-[2px]">
                    <p class="text-[10px] text-gray-300 font-mono px-4 text-center line-clamp-2">${prompt}</p>
                    <div class="flex gap-3">
                        <button onclick="window.open('${url}', '_blank')" class="bg-[#00ff88] text-black text-[10px] px-4 py-2 font-bold uppercase tracking-wider hover:bg-white transition rounded-full">Zoom 2K</button>
                        <a href="${url}" download="ProGen_2K_${idx}.png" class="border border-white text-white text-[10px] px-4 py-2 font-bold uppercase tracking-wider hover:bg-white hover:text-black transition rounded-full">Save</a>
                    </div>
                </div>
                
                <div class="absolute bottom-2 right-2 bg-black/70 px-2 py-1 border border-[#00ff88]/30 rounded">
                    <span class="text-[9px] text-[#00ff88] font-bold tracking-widest">QHD</span>
                </div>
            `;
        }

        function markError(id) {
            const div = document.getElementById(id);
            if(div) div.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-[#1a0505] border border-red-900/30"><span class="text-[10px] text-red-500 font-mono font-bold">FAILED</span></div>`;
        }

        function toggleUI(processing) {
            const btn = document.getElementById('genBtn');
            const spinner = document.getElementById('btnSpinner');
            const progress = document.getElementById('progressArea');
            const download = document.getElementById('downloadBtn');
            
            btn.disabled = processing;
            processing ? spinner.classList.remove('hidden') : spinner.classList.add('hidden');
            processing ? progress.classList.remove('hidden') : null;
            !processing ? download.classList.remove('hidden') : download.classList.add('hidden');
            
            if(processing) btn.classList.add('opacity-50', 'cursor-not-allowed');
            else btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function updateProgress(curr, total) {
            const pct = (curr/total)*100;
            document.getElementById('progressBar').style.width = `${pct}%`;
            document.getElementById('progressText').innerText = `${Math.round(pct)}%`;
            document.getElementById('statusText').innerText = `PROCESSING ${curr}/${total}`;
        }

        function clearGallery() {
            if(isProcessing) return;
            document.getElementById('imageGrid').innerHTML = `
                <div id="emptyState" class="col-span-full h-96 flex flex-col items-center justify-center border border-dashed border-gray-900 text-gray-800">
                    <p class="font-mono text-xs tracking-widest">AWAITING 2K INPUTS...</p>
                </div>
            `;
            generatedItems = [];
            toggleUI(false);
            document.getElementById('progressArea').classList.add('hidden');
        }

        async function downloadAll() {
            if (generatedItems.length === 0) return;
            const btn = document.getElementById('downloadBtn');
            const oldText = btn.innerText;
            btn.innerText = "ZIPPING 2K FILES...";
            btn.disabled = true;

            const zip = new JSZip();
            const folder = zip.folder("ProGen_2K_Output");
            generatedItems.forEach(i => folder.file(i.name, i.blob));
            
            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "ProGen_2K_Clean.zip");
            
            btn.innerText = oldText;
            btn.disabled = false;
        }
    </script>
</body>
</html>
